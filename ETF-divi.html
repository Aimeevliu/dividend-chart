import pandas as pd

# 讀取 CSV 並處理 ETF 代號補零
df = pd.read_csv("ETF_公告_收益資訊.csv")
df["交易證券代號"] = df["交易證券代號"].astype(str).str.zfill(5)

# 欄位重命名
df = df.rename(columns={
    "交易證券代號": "ETF代號",
    "交易證券名稱": "ETF名稱",
    "現金收益公布日期": "公告日期",
    "停止記載變更起日": "停止記載變更起日",
    "收益分配基準日": "收益分配基準日",
    "除息交易日": "除息日",
    "收益分配發放日": "發放日",
    "預估每單位配發金額": "預估配發金額"
})

# 補齊欄位與 NaN 處理
if "公告連結" not in df.columns:
    df["公告連結"] = "-"
df.fillna("-", inplace=True)
df["預估配發金額"] = pd.to_numeric(df["預估配發金額"], errors="coerce").fillna(0)

# 建立 HTML 表格資料列
rows = ""
for _, row in df.iterrows():
    rows += "            <tr>\n"
    for col in ["ETF代號", "ETF名稱", "除息日", "發放日", "預估配發金額"]:
        rows += f"                <td style='white-space: nowrap'>{row.get(col, '-')}</td>\n"
    link = row.get("公告連結", "-")
    rows += f'                <td>{link}</td>\n'
    rows += "            </tr>\n"

# HTML 模板
html = f"""<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ETF 最新收益分配公告</title>
    <style>
        body {{ font-family: Arial, sans-serif; background-color: #f9f9f9; color: #333; padding: 20px; text-align: center; }}
        h2 {{ font-size: 24px; font-weight: bold; margin-bottom: 15px; }}
        input {{ width: 50%; max-width: 400px; padding: 10px; margin-bottom: 20px; font-size: 16px; border: 1px solid #ccc; border-radius: 5px; text-align: center; }}
        table {{ width: 100%; border-collapse: collapse; table-layout: auto; }}
        th {{ background-color: #f4f4f4; padding: 12px; text-align: center; font-weight: bold; position: sticky; top: 0; z-index: 1; cursor: pointer; white-space: nowrap; }}
        td {{ padding: 12px; text-align: center; border-bottom: 1px solid #ddd; word-break: break-word; white-space: nowrap; }}
        tr:nth-child(even) {{ background-color: #f9f9f9; }}
        tr:hover {{ background-color: #f1f1f1; }}
        a {{ text-decoration: none; color: #007bff; font-size: 14px; }}
        a:hover {{ text-decoration: underline; }}
        .asc::after {{ content: " ⬆️"; }}
        .desc::after {{ content: " ⬇️"; }}
    </style>
</head>
<body>
    <h2>ETF 最新配息公告</h2>
    <input type="text" id="searchInput" placeholder="🔍 搜尋代號、名稱或公告內容" onkeyup="filterTable()">
    <table id="dataTable">
        <thead>
            <tr>
                <th onclick="sortTable(0, this)">ETF代號</th>
                <th>ETF名稱</th>
                <th onclick="sortTable(2, this)">除息日</th>
                <th onclick="sortTable(3, this)">股息發放日</th>
                <th onclick="sortTable(4, this)">預估配息</th>
                <th>公告連結</th>
            </tr>
        </thead>
        <tbody>
{rows}
        </tbody>
    </table>
    <script>
        function filterTable() {{
            const input = document.getElementById("searchInput").value.toLowerCase();
            const rows = document.querySelectorAll("#dataTable tbody tr");
            rows.forEach(row => {{
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(input) ? "" : "none";
            }});
        }}

        function sortTable(n, thElement) {{
            const table = document.getElementById("dataTable");
            const tbody = table.tBodies[0];
            const rowsArray = Array.from(tbody.querySelectorAll("tr"));
            const isAsc = thElement.classList.contains("asc");

            Array.from(table.querySelectorAll("th")).forEach(th => th.classList.remove("asc", "desc"));
            thElement.classList.toggle("asc", !isAsc);
            thElement.classList.toggle("desc", isAsc);

            rowsArray.sort((a, b) => {{
                const x = a.children[n].innerText.trim();
                const y = b.children[n].innerText.trim();

                const xNum = parseFloat(x.replace(/[^\d.-]/g, ""));
                const yNum = parseFloat(y.replace(/[^\d.-]/g, ""));
                const dateX = new Date(x);
                const dateY = new Date(y);

                let cmp = 0;
                if (!isNaN(xNum) && !isNaN(yNum)) {{
                    cmp = xNum - yNum;
                }} else if (!isNaN(dateX.getTime()) && !isNaN(dateY.getTime())) {{
                    cmp = dateX - dateY;
                }} else {{
                    cmp = x.localeCompare(y);
                }}

                return isAsc ? -cmp : cmp;
            }});

            rowsArray.forEach(row => tbody.appendChild(row));
        }}
    </script>
</body>
</html>
"""

# 儲存 HTML 檔案
with open("ETF_收益公告頁.html", "w", encoding="utf-8-sig") as f:
    f.write(html)

print("✅ 已儲存為 ETF_收益公告頁.html")
